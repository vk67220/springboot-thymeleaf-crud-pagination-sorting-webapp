name: Deploy to EKS with Docker Compose

on:
  workflow_dispatch:

jobs:
  build-and-docker:
    name: Build with Maven & Docker
    runs-on: [self-hosted, Linux, X64]

    steps:
      # ===================================================
      # üì• Checkout Code
      # ===================================================
      - name: Get code
        uses: actions/checkout@v4

      # ===================================================
      # üîß Maven Build (Composite Action)
      # ===================================================
      - name: Maven Build & Package
        id: maven-build
        uses: ./.github/actions/maven-build
        with:
          java-version: '17'

      - name: Print outputs
        run: |
          echo "Build Status: ${{ steps.maven-build.outputs.build-status }}"
          echo "Java Version: ${{ steps.maven-build.outputs.java-version }}"

      # ===================================================
      # üê≥ Verify Docker
      # ===================================================
      - name: Check Docker version
        run: docker --version

      - name: Check Docker Compose version
        run: docker compose version

      # ===================================================
      # üîê Login DockerHub
      # ===================================================
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # ===================================================
      # üß™ Integration Test with Docker Compose
      # ===================================================
      - name: Build and run with Docker Compose
        run: docker compose up --build -d

      - name: Show running containers
        run: docker ps

      # ---------------------------------------------------
      # Wait for MySQL
      # ---------------------------------------------------
      - name: Wait for MySQL to be healthy
        run: |
          for i in {1..30}; do
            if docker compose exec -T mysql mysqladmin ping -h localhost -uroot -proot --silent; then
              echo "MySQL is healthy!"
              exit 0
            fi
            echo "Waiting for MySQL..."
            sleep 10
          done
          docker compose logs mysql
          exit 1

      # ---------------------------------------------------
      # Wait for Application
      # ---------------------------------------------------
      - name: Check application health
        run: |
          for i in {1..40}; do
            if curl -f http://localhost:2323 >/dev/null 2>&1; then
              echo "Application is UP!"
              exit 0
            fi
            echo "Waiting for App..."
            sleep 5
          done
          docker compose logs springboot-app
          exit 1

      # ===================================================
      # üì¶ Tag & Push Docker Image
      # ===================================================
      - name: Tag & Push Docker Image
        run: |
          IMAGE="${{ secrets.DOCKERHUB_USERNAME }}/springboot-app:${{ github.run_number }}"

          docker tag springboot-app:latest $IMAGE
          docker push $IMAGE

          echo "IMAGE=$IMAGE" >> $GITHUB_ENV

      # ===================================================
      # üßπ Stop Compose (Composite Action)
      # ===================================================
      - name: Down Docker Compose
        id: down
        uses: ./.github/actions/docker-compose-down

      - name: Print final outputs
        run: |
          echo "Docker Compose Down Status: ${{ steps.down.outputs.status }}"

      # ===================================================
      # ‚òÅÔ∏è Configure AWS
      # ===================================================
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # ===================================================
      # ‚ò∏Ô∏è Verify kubectl
      # ===================================================
      - name: Check kubectl version
        run: kubectl version --client

      # ===================================================
      # üîó Connect to EKS
      # ===================================================
      - name: Update kubeconfig for EKS
        run: |
          aws eks update-kubeconfig \
            --region "${{ secrets.AWS_REGION }}" \
            --name "${{ secrets.EKS_CLUSTER_NAME }}"

      # ===================================================
      # üöÄ Deploy to EKS
      # ===================================================
      - name: Deploy to EKS
        run: |
          sed -i "s|DOCKER_IMAGE|$IMAGE|g" deployment.yml
          kubectl apply -f deployment.yml
          kubectl apply -f service.yml

      # ===================================================
      # ‚úÖ Verify rollout
      # ===================================================
      - name: Verify rollout
        run: |
          kubectl rollout status deployment/springboot-deployment
          kubectl get svc springboot-service
