name: First Workflow

on:
  workflow_dispatch:

jobs:
  build-and-docker:
    name: Build with Maven & Docker
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout source code
      - name: Get code
        uses: actions/checkout@v4

      # 2️⃣ Setup Java
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      # 3️⃣ Verify Maven
      - name: Verify Maven
        run: mvn -version
      - name: Handle failure
        if: failure()
        run: echo "Maven setup failed. Please check the logs for details."
      # 4️⃣ Build application
      - name: Build package
        if: always()
        run: |
          mvn clean package -DskipTests
          ls -la target/
  #Docker_build:
    #name: Build Docker Image
    #runs-on: ubuntu-latest

    #steps:
      # 1️⃣ Checkout source code
      #- name: Get code
        #uses: actions/checkout@v4

      # 2️⃣  Docker login
      - name: Docker login
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Build docker image
        run: |
          docker build -t myapp:latest .
          docker tag myapp:latest ${{ secrets.DOCKERHUB_USERNAME }}/myapp:latest
          docker tag myapp:latest ${{ secrets.DOCKERHUB_USERNAME }}/myapp:${{ github.run_number }}
      
      - name: Verify docker image
        run: docker images | grep myapp

      - name: Push docker image
        run: |
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/myapp:latest
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/myapp:${{ github.run_number }}   
      - name: Docker run container
        run: |
          docker run -d --name myapp-test -p 8080:8080 ${{ secrets.DOCKERHUB_USERNAME }}/myapp:${{ github.run_number }}
      - name: list running containers
        run: docker ps

      - name: Verify container is running
        run: |
          sleep 10
          curl -f http://localhost:8080/ || exit 1

      - name: containers logs
        if: always()
        run: docker logs myapp-test